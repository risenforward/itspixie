import QueryChooser from 'components/Markdown/QueryChooser'
import Collapse from 'components/Markdown/Collapse'
import Warning from 'components/Markdown/Warning'

export const meta = {
  title: 'Build API Servers with Prisma',
  gettingStartedTitle: 'GraphQL API',
  step: 3,
  position: 1,
  nextText: 'Congratulations! ðŸš€ You made it through the quickstart tutorial and learned how to use Prisma and the Prisma Client to build a GraphQL server.'
}

## Goals

On this page, you will learn how to:

- Define a GraphQL schema for your GraphQL server
- Implement resolver functions using the Prisma Client
- Use the GraphQL Playground to explore a GraphQL API

## Configure Project

[`grahpql-yoga`](https://github.com/prisma/graphql-yoga) is a GraphQL server library based on [Express.js](https://expressjs.com/). Add it to your project with the following command:

```bash copy
npm install graphql-yoga --save
```

## Define GraphQL API

Every GraphQL API is based on a [GraphQL schema](https://www.prisma.io/blog/graphql-server-basics-the-schema-ac5e2950214e/) that specifies all API operations and data structures. The schema is as a _contract_ between client and server.

Create a new file called `schema.graphql`:

```bash copy
touch schema.graphql
```

To define the API operations, you need to specify the `Query` and `Mutation` types in your GraphQL schema - the following operations are examples for a simple blogging application:

```graphql copy
type Query {
  publishedPosts: [Post!]!
  post(postId: ID!): Post
  postsByUser(userId: ID!): [Post!]!
}

type Mutation {
  createUser(name: String!): User
  createDraft(title: String!, userId: ID!): Post
  publish(postId: ID!): Post
}

type User {
  id: ID!
  email: String
  name: String!
  posts: [Post!]!
}

type Post {
  id: ID!
  title: String!
  published: Boolean!
  author: User
}
```

> The `Post` and `User` types are straightforward re-definitions of the models specified in `datamodel.graphql`, except that the Prisma-specific directives have been removed.

## Implement resolver functions

Here is how you implement the resolver functions for the six API operations defined in the GraphQL schema. Replace the current contents of `index.js` entirely with the following code snippet:

```js lineNumbers,copy
const { Prisma } = require('./prisma')
const { GraphQLServer } = require('graphql-yoga')

const resolvers = {
  Query: {
    publishedPosts(root, args, context) {
      return context.prisma.posts({ where: { published: true } })
    },
    post(root, args, context) {
      return context.prisma.post({ id: args.postId })
    },
    postsByUser(root, args, context) {
      return context.prisma.user({
        id: args.userId
      }).posts()
    }
  },
  Mutation: {
    createDraft(root, args, context) {
      return context.prisma.createPost(
        {
          data: {
            title: args.title,
            author: {
              connect: { id: args.userId }
            }
          },
        },

      )
    },
    publish(root, args, context) {
      return context.prisma.updatePost(
        {
          where: { id: args.postId },
          data: { published: true },
        },

      )
    },
    createUser(root, args, context) {
      return context.prisma.createUser(
        { name: args.name },
      )
    }
  },
  User: {
    posts(root, args, context) {
      return context.prisma.user({
        id: root.id
      }).posts()
    }
  },
  Post: {
    author(root, args, context) {
      return context.prisma.post({
        id: root.id
      }).author()
    }
  }
}
```

Each resolver invokes a method on the Prisma Client instance which is called `prisma` and attached to the `context` object.

## Configure your GraphQL server

Now you need to instantiate the `GraphQLServer` from the `graphql-yoga` library and pass the GraphQL schema along with its resolver functions. You're also instantiating the `Prisma` Client instance and attach it to the `context` so that the resolvers can access it:

```js lineNumbers,copy
const server = new GraphQLServer({
  typeDefs: './schema.graphql',
  resolvers,
  context: req => ({
    ...req,
    prisma: new Prisma(),
   }),
})
server.start(() => console.log('Server is running on http://localhost:4000'))
```

## Start the GraphQL server

To start the GraphQL server, run the following command:

```bash copy
node index.js
```

## Explore the GraphQL API of the application layer in a Playground

The GraphQL API of your application layer now exposes the six operations defined in `schema.graphql`. To test these operations, navigate your browser to [`http://localhost:4000`](http://localhost:4000) where a [GraphQL Playground](https://github.com/prisma/graphql-playground) is running.

<Collapse title="Learn more about the GraphQL Playground">

A GraphQL Playground is an interactive GraphQL IDE that lets you explore the operations of GraphQL API. You can click the green **SCHEMA**-button at the right edge of the Playground window to view the auto-generated documentation for your GraphQL API.

![](https://imgur.com/7vJGm8a.png)

</Collapse>


Here are a few sample queries and mutations you can send to explore the API.

<QueryChooser titles={["Create a new User", "Create new draft", "Publish a Post", "Fetch published Posts"]}>

```graphql lineNumbers,copy
mutation {
  createUser(name: "Bob") {
    id
  }
}
```

```graphql lineNumbers,copy
mutation {
  createDraft(
    title: "GraphQL is great"
    userId: "__USER_ID__"
  ) {
    id
    published
    author {
      id
    }
  }
}
```

```graphql lineNumbers,copy
mutation {
  publish(postId: "__POST_ID__") {
    id
    title
    published
  }
}
```

```graphql lineNumbers,copy
query {
  publishedPosts {
    id
    title
    author {
      id
      name
    }
  }
}
```

</QueryChooser>

## Best practices for your GraphQL server

<Collapse title="File Structure">

Here are some hints for structuring your project:

- Include the directory that contains the service configuration files for your Prisma service (in your case that's the `hello-world` directory) _inside_ the project directory of the GraphQL server.
- The GraphQL schema of your Prisma API (called `prisma.graphql`) should be available in the directory where the source code for your GraphQL server is located. As it's auto-generated, it is helpful to put it into a dedicated directory, e.g. called `generated`.
- Use `graphql-config` to enable the GraphQL Playground to show the two GraphQL APIs (Prisma and application server) side-by-side.

Here's how your project structure will look like if you follow above:

```
.
â”œâ”€â”€ .graphqlconfig
# defines the Prisma service (database layer)
â”œâ”€â”€ hello-world
â”‚   â”œâ”€â”€ datamodel.graphql
â”‚   â””â”€â”€ prisma.yml
# implementation of the GraphQL server (application layer)
â”œâ”€â”€ src                     
â”‚   â”œâ”€â”€ generated
â”‚   â”‚   â””â”€â”€ prisma.graphql
â”‚   â”œâ”€â”€ index.js
â”‚   â””â”€â”€ schema.graphql
â”œâ”€â”€ package.json
â””â”€â”€ yarn.lock
```

</Collapse>

<Collapse title="GraphQL Config">

Your `.graphqlconfig.yml` file needs to define both GraphQL _projects_ you're working with:

```yml
projects:
  app:
    schemaPath: src/schema.graphql
    extensions:
      endpoints:
        default: http://localhost:4000
  hello-world:
    schemaPath: src/generated/prisma.graphql
    extensions:
      prisma: hello-world/prisma.yml
```

This allows to quickly switch between the two GraphQL APIs using the sidenav inside the GraphQL Playground. Note that for this to work you need to open the Playground using the `graphql playground` command (from the GraphQL CLI) inside the same directory where your `.graphqlconfig` is located. 

</Collapse>

<Collapse title="Keep the GraphQL schema of your Prisma API up-to-date">

Prisma's auto-generated GraphQL schema changes whenever you deploy changes to the service's data model. To ensure your local `prisma.graphql` stays up-to-date you can configure a post-deployment _hook_ which updates it after every deploy.

You can configure the hook in `prisma.yml`:

```yml
datamodel: datamodel.graphql
endpoint: http://localhost:4466 # or some other endpoint

hooks:
  post-deploy:
    - graphql get-schema --endpoint ${self:endpoint} --output src/generated/prisma.graphql --no-all
```

This assumes that the GraphQL CLI is installed globally on your machine.

</Collapse>